# telnetを使い、SMTPを手書きしてみよう

「telnetを使い、SMTPを手書きしてみよう！」ハンズオンの資料です。  
各自、自分のペースで進めてみて下さい。

## 事前準備

ハンズオン用メールサーバーを自分で用意する場合は、[こちらの資料](./preparation/README.md)を利用して構築して下さい。  
(セキュリティ・キャンプ2025ミニ（石川開催）参加者の皆さんは、講師が用意したサーバーを利用できますので、こちらの手順は不要です)

## 正常なメールを送ってみよう

### telnetでハンズオン用SMTPサーバーに接続する

いよいよSMTPサーバーに接続してみましょう。  
以下のコマンドで、ハンズオン用SMTPサーバーに接続します。

```bash
telnet server.ishikawa-mini.camp 25
```

以下のような表示が出れば成功です！

```console
user@ishikawa-mail-server:~$ telnet server.ishikawa-mini.camp 25
Trying 127.0.0.1...
Connected to server.ishikawa-mini.camp.
Escape character is '^]'.
220 server.ishikawa-mini.camp ESMTP Postfix (Ubuntu)
```

---

<details>
<summary>コマンドに関する補足説明</summary>

telnetは、本来SSH同様、他のコンピューターを遠隔操作するために生まれたコマンドです。  
現在はSSHが主流になり、上記の目的ではほぼ使われなくなりました。

telnetは今回のように、任意のアドレス・ポートに対してTCP接続を行い、手書きでデータをやり取りするという目的でも使うことができます。  
今回は、SMTPプロトコルを手書きするという目的のため、telnetを使ってTCP接続を行い、その上でSMTPプロトコルのテキストを送り合う方式を採用しました。

今回のコマンドでは、`server.ishikawa-mini.camp`というアドレスの25番ポート (SMTP通信用ポート) に対して接続しています。

`server.ishikawa-mini.camp`は今ログインしているサーバー自身を示しています。  
以下のコマンドで確認してみると良いでしょう。

```bash
cat /etc/hosts
```

今回用意した環境ではPostfixというメールサーバーソフトウェアが動作しており、そこに対してSMTP接続を行っています。  
わざわざ自分自身に対してSMTP接続を行うのは不思議に思えるかもしれませんが、これはOP25B (講義で補足) という仕組みの回避策です。

</details>

---

### SMTPを手書きしてみる

講義で触れたとおり、SMTPは**対話型のプロトコル**です。  
コマンドを一つ一つ入力して自分の情報 / メールの情報を渡し、それぞれに対してサーバーが応答を返してくれます。

以下のような流れで送信を行います。  
全ての場所に置いて、**日本語を入力してしまうと文字化けします**！  
ご注意ください。

- 自己紹介をする
  - まずは自己紹介をします。以下の文字列を入力して下さい。
  - `{自分の好きな文字列}`は本来自分のアドレスを入れますが、適当な文字列でも大丈夫です。

  ```bash
  HELO {自分の好きな文字列}
  ```

  - `250 server.ishikawa-mini.camp`と出れば成功です！
- 送り主を伝える
  - 送り主のアドレスを伝えます。以下の文字列を入力してください。
  - `{自分のメールアドレス}`は、各自置き換えてください。

  ```bash
  MAIL FROM: {自分のメールアドレス}
  ```

  - `250 2.1.0 Ok`と出れば成功です！
- 宛先を伝える
  - 宛先のアドレスを伝えます。以下の文字列を入力してください。
  - 今回は講師のPCで受信するため、**宛先は固定**です。

  ```bash
  RCPT TO: trainer@ishikawa-mini.camp
  ```

  - `250 2.1.5 Ok`と出れば成功です！
- メールの内容を入力する
  - メールの内容を入力します。まずは以下の文字列を入力してください。

  ```bash
  DATA
  ```

  - `354 End data with <CR><LF>.<CR><LF>`と出て、**情報を入力する準備が整った**ことが通知されます。
  - その後、以下のように文字列を入力します。`{}`で囲まれた文字列は、適宜置き換えてください。

  ```bash
  From: {自分のメールアドレス}
  To: trainer@ishikawa-mini.camp
  Subject: {メールの件名 (自由)}

  {メールの本文 (自由)}
  .
  ```

  - **最後の`.`(ピリオド) を打った後にEnterを押す**と、メールが送信されます。
    - ローマ字・英数字しか打ち込んでない場合は、`250 2.0.0 OK: queued as {メールID}`と出れば成功です！
    - 日本語を含むメールを送信した場合はおそらく何も表示されませんが、講師のPCで受信できていれば成功です！
- SMTPを終了する
  - 最後に、以下の文字列を入力してください。

  ```bash
  QUIT
  ```

  - `Connection closed by foreign host.`と出て、コマンドが終了していれば成功です！
  - これでSMTP通信が終了しました。

以上のコマンドを打ち終わると、下のような画面になるはずです。
![log](images/7.png)

---

<details>
<summary>コマンドに関する補足説明</summary>

- `HELO`コマンド
  - SMTPサーバーに対して自分の情報を伝えるためのコマンドです。
  - 本来は、自分側のメールサーバーのアドレス (`security-camp.or.jp`など) を打ち込みますが、この部分は適当な文字列でも通ります。
- `MAIL FROM`コマンド
  - 送り主のアドレスを伝えるためのコマンドですが、ほぼ意味を成していません。
  - 「エンベロープFrom」と呼ばれます。
  - 何のアドレスを入れても良いです。
- `RCPT TO`コマンド
  - 宛先のアドレスを伝えるためのコマンドです。
- `DATA`コマンド
  - メールの内容を入力するためのコマンドです。
  - 最初に「ヘッダ」と呼ばれる、メールに関するメタ情報を羅列し、一度空行を挟んだ後、`改行 + ピリオド + 改行`までが本文とみなされます。
  - `From`ヘッダ
    - **メールを表示するときに**、送り主として表示するための情報です。
    - 「ヘッダFrom」と呼ばれます。
    - メールの伝送のために使われることはありません。
    - SMTPでは本来どんなアドレスでも入れて良いですが、Brevoの独自規制で、Brevoに登録したメールアドレスを入れる必要があります。
  - `To`ヘッダ
    - **メールを表示するときに**、宛先として表示するための情報です。
    - メールの伝送のために使われることはありません。
- `QUIT`コマンド
  - SMTP通信を終了するためのコマンドです。

</details>

---

### 正しく送られたことを確かめる

送信したメールが正しく送られたかは、以下の方法で確かめられます。

- 宛先メールアドレスのメールボックスを確認する
  - **迷惑メールフォルダなどに入っているかも**しれませんので、そちらも確認してみてください。
- Brevoのダッシュボードから確認する
  - <https://app-smtp.brevo.com/real-time> にアクセスし、メールの送信状況を確認してみてください。
  - 次のように、「Delivered」となっているログがあれば成功です。  
    ![delivered](images/8.png)

## 危険なメールを送信してみよう

ここまででSMTPを直接手書きできるようになったため、ここからは**あえて危険なメールをシミュレート**してみましょう。

### Fromの改変 (なりすまし)

以下のように、`MAIL FROM`と`DATA`で入力する`From`部分を変更します。  
自分が持っていようが持っていまいが、自由なアドレスでかまいません。
![dangerous mail](images/9.png)

最後に`250 2.0.0 OK`と書かれているので、**SMTPプロトコルとしては正常に送られています**。  
ですが、<https://app-smtp.brevo.com/real-time> を見ると、Brevoが独自に**登録されていないメールアドレスからの送信を規制している**ことがわかります。

![dangerous mail log](images/10.png)

なお、`MAIL FROM`で打ち込むアドレスのみ改変した場合は通りますが、`DATA`の`From`部分を改変した場合は通りません。  
これによって、メールを見るときに**表示される送り主がなりすまされることを防ぐ**というBrevoの対策であることがわかります。

### Fromに別名を付ける

Fromの直接改変より騙すことができる確率は低いですが、**`DATA`の`From`部分には「表示名」として別名を付ける**ことができます。

例えば今回は「セキュキャン銀行公式」(Seccamp Bank Official) を名乗ってみましょう。  
`DATA`の`From`部分を以下のように入力します。

```bash
Seccamp Bank Official <{Brevoに登録したメールアドレス}>
```

![fake mail](images/11.png)

`<>`で**囲まれた部分が実際のメールアドレス**、その**前までの部分が表示名**として扱われます。

これでメールを送ると、送り主が「Seccamp Bank Official」となったメールが送信されるはずです。  
自分のメールボックスを確認してください。

![fake mail result](images/12.png)

## 自由にメールを送信してみよう

ここまでのハンズオンで得た知識を活かして、いろんな宛名や内容でメールを送信してみましょう！  
普段メールを送信する際、このようなプロトコルが後ろにあるんだなぁと思って下さると幸いです。

**他人に危険なメールを送ることは犯罪になり得ます！**  
十分注意してください。

## 参考文献

- <https://www.tohoho-web.com/ex/draft/smtp.htm>
- <https://www.tohoho-web.com/ex/draft/smtp-auth.htm>
- <https://baremail.jp/blog/2021/05/25/1377/>
- <https://qiita.com/uenosy/items/1c95701bf743236a2f6b>
